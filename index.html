<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CupidX â€” Compatibility Coach</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
      .hidden { display: none; }
      .modal-bg {
        background: rgba(0,0,0,0.4);
        position: fixed; top:0; left:0; width:100vw; height:100vh; z-index:50;
        display:flex; align-items:center; justify-content:center;
      }
      .spinner { border:2px solid #f3f3f3; border-radius:50%; border-top:2px solid #555; width:20px; height:20px; animation:spin .6s linear infinite; }
      @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
      .fade-enter { animation: fadeIn .3s linear; }
      @keyframes fadeIn { 0%{opacity:0} 100%{opacity:1} }
    </style>
  </head>
  <body class="min-h-screen bg-gray-50 flex items-center justify-center">
    <main id="mainPanel" class="w-full max-w-sm mx-auto mt-8 p-6 bg-white shadow-lg rounded-lg">
      <!-- Registration Form (displays on load) -->
      <form id="regForm" autocomplete="off" class="space-y-4 fade-enter">
        <h1 class="text-xl font-bold mb-2 text-indigo-700">CupidX Registration</h1>

        <div>
          <label for="name" class="block font-medium mb-1">Full Name</label>
          <input id="name" name="name" type="text" required class="w-full p-2 border rounded" />
        </div>

        <div>
          <label for="email" class="block font-medium mb-1">Email</label>
          <input id="email" name="email" type="email" required class="w-full p-2 border rounded" autocomplete="email" />
        </div>

        <!-- DOB: day, month, year split inputs with merge/validation -->
        <div>
          <label class="block font-medium mb-1">Date of Birth</label>
          <div class="grid grid-cols-3 gap-2">
            <input id="dob-day" inputmode="numeric" pattern="\\d{1,2}" maxlength="2" placeholder="DD" class="p-2 border rounded text-center" aria-label="Day" />
            <input id="dob-month" inputmode="numeric" pattern="\\d{1,2}" maxlength="2" placeholder="MM" class="p-2 border rounded text-center" aria-label="Month" />
            <input id="dob-year" inputmode="numeric" pattern="\\d{4}" maxlength="4" placeholder="YYYY" class="p-2 border rounded text-center" aria-label="Year" />
          </div>
          <p id="dob-error" class="mt-1 text-sm text-red-600 hidden"></p>
          <!-- hidden merged field used for submission -->
          <input id="dob" name="dob" type="hidden" />
        </div>

        <button id="submitBtn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">Continue</button>
      </form>

      <!-- Results panels, placeholders kept -->
      <section id="blueprintPanel" class="mt-4"></section>
      <section id="fitPanel" class="mt-4"></section>
      <section id="vibePanel" class="mt-4"></section>
    </main>

    <script>
      function pad2(n){ return n.toString().padStart(2,'0'); }
      function isValidISODate(iso){
        // Expect YYYY-MM-DD and must be a real calendar date
        if(!/^\\d{4}-\\d{2}-\\d{2}$/.test(iso)) return false;
        const [y,m,d] = iso.split('-').map(Number);
        const dt = new Date(Date.UTC(y, m-1, d));
        return dt.getUTCFullYear() === y && (dt.getUTCMonth()+1) === m && dt.getUTCDate() === d;
      }
      function ageFromISO(iso){
        const [y,m,d] = iso.split('-').map(Number);
        const today = new Date();
        let age = today.getFullYear() - y;
        const mDiff = (today.getMonth()+1) - m;
        const dDiff = today.getDate() - d;
        if (mDiff < 0 || (mDiff === 0 && dDiff < 0)) age--;
        return age;
      }

      function mergeAndValidateDob(){
        const dayEl = document.getElementById('dob-day');
        const monEl = document.getElementById('dob-month');
        const yearEl = document.getElementById('dob-year');
        const hiddenEl = document.getElementById('dob');
        const errEl = document.getElementById('dob-error');

        const dd = dayEl.value.trim();
        const mm = monEl.value.trim();
        const yyyy = yearEl.value.trim();

        // Basic presence
        if(!dd || !mm || !yyyy){
          errEl.textContent = 'Please enter day, month, and year.';
          errEl.classList.remove('hidden');
          return { ok:false };
        }

        // Normalize and numeric checks
        if(!/^\\d{1,2}$/.test(dd) || !/^\\d{1,2}$/.test(mm) || !/^\\d{4}$/.test(yyyy)){
          errEl.textContent = 'Invalid format. Use DD, MM, and YYYY.';
          errEl.classList.remove('hidden');
          return { ok:false };
        }
        const d = Number(dd);
        const m = Number(mm);
        const y = Number(yyyy);
        if(m < 1 || m > 12){
          errEl.textContent = 'Month must be between 1 and 12.';
          errEl.classList.remove('hidden');
          return { ok:false };
        }
        if(d < 1 || d > 31){
          errEl.textContent = 'Day must be between 1 and 31.';
          errEl.classList.remove('hidden');
          return { ok:false };
        }

        const iso = `${y}-${pad2(m)}-${pad2(d)}`;
        if(!isValidISODate(iso)){
          errEl.textContent = 'That date doesn\'t look valid. Please check the day, month, and year.';
          errEl.classList.remove('hidden');
          return { ok:false };
        }

        const age = ageFromISO(iso);
        if(age < 18){
          errEl.textContent = 'You must be at least 18 years old to register.';
          errEl.classList.remove('hidden');
          return { ok:false };
        }

        errEl.textContent = '';
        errEl.classList.add('hidden');
        hiddenEl.value = iso;
        return { ok:true, iso };
      }

      ['dob-day','dob-month','dob-year'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => {
          // Auto-advance when reaching maxlength
          const max = Number(el.getAttribute('maxlength') || 2);
          if(el.value.length >= max){
            if(id === 'dob-day') document.getElementById('dob-month').focus();
            if(id === 'dob-month') document.getElementById('dob-year').focus();
          }
          mergeAndValidateDob();
        });
        el.addEventListener('blur', mergeAndValidateDob);
      });

      document.getElementById('regForm').addEventListener('submit', (e) => {
        const { ok } = mergeAndValidateDob();
        if(!ok){
          e.preventDefault();
          return;
        }
        // Continue with your existing submission logic here (e.g., Supabase or next steps)
      });
    </script>
  </body>
</html>
